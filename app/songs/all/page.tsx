"use client";

import { useState } from "react";
import { motion } from "framer-motion";
import Link from "next/link";
import { ArrowLeft } from "lucide-react";

import useGetAllSongsPaginated from "@/hooks/data/useGetAllSongsPaginated";
import useOnPlay from "@/hooks/player/useOnPlay";
import usePlayer from "@/hooks/player/usePlayer";

import SongItem from "@/components/Song/SongItem";
import SongItemSkeleton from "@/components/Song/SongItemSkeleton";
import Pagination from "@/components/common/Pagination";

const PAGE_SIZE = 24;

/**
 * 全曲一覧ページ
 *
 * Latest Releases の「全てを表示」から遷移する詳細ページ
 * ページネーション対応で全曲を閲覧可能
 */
export default function AllSongsPage() {
  const [page, setPage] = useState(0);

  // データ取得（TanStack Queryでキャッシュ管理）
  const { songs, totalPages, isLoading } = useGetAllSongsPaginated(
    page,
    PAGE_SIZE,
  );

  // 再生機能
  const player = usePlayer();
  const onPlay = useOnPlay(songs);

  const handlePlay = (id: string) => {
    onPlay(id);
    player.setId(id);
  };

  const handlePageChange = (newPage: number) => {
    setPage(newPage);
    // ページ変更時にトップにスクロール
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.05 } },
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.3 } },
  };

  return (
    <div className="flex bg-[#0a0a0f] h-full overflow-hidden font-mono relative">
      {/* グローバル装飾 */}
      <div className="absolute inset-0 opacity-[0.02] pointer-events-none" 
           style={{ 
             backgroundImage: `linear-gradient(rgba(var(--theme-500), 0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--theme-500), 0.5) 1px, transparent 1px)`,
             backgroundSize: '100px 100px'
           }} 
      />

      <div className="w-full h-full overflow-y-auto custom-scrollbar relative z-10">
        <main className="px-8 py-12 pb-32 max-w-[1600px] mx-auto">
          {/* ヘッダー (HUD Style) */}
          <div className="mb-12 border-l-4 border-theme-500 pl-6 relative">
            <div className="absolute -top-4 -left-1 text-[8px] text-theme-500/40 uppercase tracking-[0.5em]">
               archive_access: authorized
            </div>
            
            <Link
              href="/"
              className="inline-flex items-center gap-2 text-theme-500/60 hover:text-white transition-all duration-300 mb-6 uppercase text-[10px] font-black tracking-widest group"
            >
              <ArrowLeft size={14} className="group-hover:-translate-x-1 transition-transform" />
              <span>[ BACK_TO_CENTRAL_HUB ]</span>
            </Link>
            
            <h1 className="text-4xl md:text-6xl font-black text-white tracking-tighter uppercase drop-shadow-[0_0_15px_rgba(var(--theme-500),0.8)] cyber-glitch">
              LATEST_SIGNAL_RELEASE
            </h1>
            <p className="text-theme-500/60 mt-2 text-xs uppercase tracking-widest italic">
              // DECRYPTING_ALL_RECENT_BINARY_STREAMS_IN_THIS_SECTOR
            </p>
            
            {/* 装飾用HUDパーツ */}
            <div className="absolute top-0 right-0 w-24 h-px bg-gradient-to-l from-theme-500/40 to-transparent" />
          </div>

          {/* 曲一覧 */}
          {isLoading && songs.length === 0 ? (
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
              {Array.from({ length: PAGE_SIZE }).map((_, i) => (
                <SongItemSkeleton key={i} />
              ))}
            </div>
          ) : songs.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-32 border border-dashed border-theme-500/20 bg-theme-500/5">
              <p className="text-theme-500/60 uppercase tracking-[0.4em] text-sm animate-pulse">
                [ ! ] NO_DATA_STREAMS_DETECTED_IN_ARCHIVE
              </p>
            </div>
          ) : (
            <motion.div
              variants={containerVariants}
              initial="hidden"
              animate="visible"
              className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"
            >
              {songs.map((song) => (
                <motion.div
                  key={song.id}
                  variants={itemVariants}
                  className="group relative"
                >
                  <SongItem onClick={handlePlay} data={song} />
                </motion.div>
              ))}
            </motion.div>
          )}

          {/* ページネーション (HUD Style) */}
          {totalPages > 1 && (
            <div className="mt-20 pt-10 border-t border-theme-500/10">
              <div className="flex justify-between items-center mb-4">
                 <span className="text-[8px] text-theme-500/20 uppercase tracking-widest font-bold">
                    sector_index: {page + 1} // total_blocks: {totalPages}
                 </span>
                 <div className="h-px flex-1 mx-8 bg-gradient-to-r from-theme-500/20 via-transparent to-transparent" />
              </div>
              <Pagination
                currentPage={page}
                totalPages={totalPages}
                onPageChange={handlePageChange}
              />
            </div>
          )}
        </main>
      </div>
    </div>
  );
}
