# バグレポート: Supabase 認証が原因のタブ復帰時プレイヤー再生位置リセット問題

## 概要

- Supabase 認証を利用したログイン状態でのみ、タブを非アクティブ → アクティブに戻すとページ全体が再フェッチされ、プレイヤーも強制的に再レンダリングされる。
- その結果、再生位置が 0 にリセットされ、停止中でも再生が始まる。
- 未ログイン状態ではこの現象は発生しない。

## 技術的背景

- Supabase 認証状態の検証（セッション検証や userDetails 取得）がトリガーとなり、ページ全体の再フェッチや再レンダリングが発生している。
- プレイヤー状態（再生位置・再生状態）はローカル state とグローバル state（Zustand 等）で管理されているが、ページ再フェッチ時に初期化される。
- Supabase 認証状態の検証や API 通信の副作用が、audio 要素や player state の初期化・再生制御に直接影響している。

## 現象の詳細

- Supabase 認証によるログイン状態でのみ、タブ復帰時に再生位置が 0 に戻り、停止中でも再生が始まる。
- 未ログインや他の環境では発生しない。
- Supabase 認証状態の変化や userDetails の取得タイミング、API 通信の副作用が player state や audio 要素の初期化・再生制御に影響している。
- 以前は発生しなかったが、最近になって顕在化。

## 原因の推定

- Supabase 認証状態の検証やセッション再取得が、Next.js/React アプリのページ再フェッチやコンポーネント再レンダリングを引き起こし、audio プレイヤーの状態が初期化される。
- Supabase 認証状態の検証や API 通信の副作用が、audio 要素や player state の初期化・再生制御に直接影響している。
- 状態管理（グローバル/ローカル）の分散や依存配列設計の不備が、再生状態の不整合を生んでいる可能性。

## 多角的な調査観点

1. Supabase 認証状態（userDetails, session, accessToken）の変化が player state や audio 要素の初期化・再生制御にどのように影響しているか
2. useOnPlay, usePlayHistory, useUser など Supabase 認証に依存した副作用や API 通信が、再生位置・再生状態のリセットや再生開始のトリガーになっていないか
3. ログイン時のみ発火する useEffect やコールバック、API 通信の遅延・失敗が player state に与える影響
4. 状態管理（グローバル/ローカル）の分散や依存配列設計の不備が、再生状態の不整合を生んでいないか
5. Supabase や TanStack Query のキャッシュ・再取得タイミングが player state に副作用を与えていないか

## AI/技術者向けクエリ例

- 「Supabase 認証状態の検証やセッション再取得が、Next.js/React アプリのページ再フェッチやコンポーネント再レンダリングを引き起こし、audio プレイヤーの状態が初期化される現象の根本原因と対策を知りたい」
- 「Supabase 認証状態でのみタブ復帰時にページ全体が再フェッチされ、audio プレイヤーの再生位置や再生状態がリセットされる場合、どのような認証・状態管理設計が望ましいか」
- 「Supabase 認証や TanStack Query のユーザー情報取得が、アプリの再レンダリングや副作用のトリガーとなる場合のベストプラクティスを知りたい」
- 「Supabase 認証状態の検証や API 通信の副作用が、audio 要素や player state の初期化・再生制御に与える影響を最小化する設計パターンを調査したい」

---

このレポートは、Supabase 認証が原因で発生する現象の本質・技術的背景・調査観点を多角的に整理し、AI や他の技術者が体系的に分析・議論しやすいようにまとめています。
